<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sudan Displacement Timeline</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
  height: 88vh;  /* 使用视口高度单位 */
  width: 98%;    /* 稍微减少宽度 */
  margin: 15px auto; /* 居中显示 */
  background: #f0f0f0;
  position: relative;
  border-radius: 8px; /* 添加圆角 */
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); /* 添加投影 */
}
    
    .legend {
      padding: 10px;
      font: 12px Arial, sans-serif;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      border-radius: 5px;
      min-width: 200px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .legend-color {
      width: 25px;
      height: 25px;
      margin-right: 12px;
      border: 2px solid #333;
    }
    
    #timeline-container {
        width: 60%;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      right: auto;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    #timeline {
      width: 100%;
      margin: 10px 0;
    }
    
    #date-display {
      text-align: center;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    #controls {
        position: absolute;
      top: 20px;  /* 改为顶部定位 */
      left: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    
    #play-button {
      padding: 8px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    #play-button:hover {
      background: #45a049;
    }
    #admin-level {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    .leaflet-interactive.admin-boundary-1 {
      stroke-width: 3px;
      stroke-linecap: round;
      animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
      0% { stroke-opacity: 0.8; }
      50% { stroke-opacity: 0.4; }
      100% { stroke-opacity: 0.8; }
    }

    .leaflet-interactive.admin-boundary-2 {
      stroke-dasharray: 3, 3;
      stroke-linecap: square;
    }

  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <select id="admin-level">
        <option value="1">Admin Level 1</option>
        <option value="2" selected>Admin Level 2</option>
      </select>
    <button id="play-button">▶ Play</button>
  </div>
  <div id="timeline-container">
    <div id="date-display">Date: loading...</div>
    <input type="range" id="timeline" min="0" value="0" step="1">
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 全局变量
    let map;
    let currentGeoLayer = null;
    let allDisplacementData = [];
    let dates = [];
    let geoJsonData;
    let isPlaying = false;
    let playInterval;
    let currentAdminLevel = 2;
    let currentDataUrl = "";
    // 初始化地图
    function initMap() {
        map = L.map('map', {
            center: [15.5007, 32.5599],  // 使用更合理的中心点
    zoom: 6.2,            // 调整到更安全的缩放级别
    zoomSnap: 0.1,
    zoomControl: false,
    attributionControl: false
  });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        minZoom: 3,          // 匹配服务支持的最小缩放
    maxZoom: 18,          // 匹配服务支持的最大缩放
      }).addTo(map);

      
      L.control.zoom({ position: 'topright' }).addTo(map);
    }

    // 名称标准化函数
    const normalizeName = (name) => {
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]/g, '')
        .replace(/(province|state|city|district|county)/g, '')
        .trim();
    };

    // 模糊匹配算法
    const levenshteinDistance = (s1, s2) => {
      const m = s1.length, n = s2.length;
      const d = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));

      for (let i = 0; i <= m; i++) d[i][0] = i;
      for (let j = 0; j <= n; j++) d[0][j] = j;

      for (let j = 1; j <= n; j++) {
        for (let i = 1; i <= m; i++) {
          const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
          d[i][j] = Math.min(
            d[i - 1][j] + 1,
            d[i][j - 1] + 1,
            d[i - 1][j - 1] + cost
          );
        }
      }
      return d[m][n];
    };

    const findClosestMatch = (name, names, maxDistance = 3) => {
      let closestMatch = null;
      let minDistance = Infinity;
      names.forEach(candidate => {
        const distance = levenshteinDistance(name, candidate);
        if (distance < minDistance && distance <= maxDistance) {
          minDistance = distance;
          closestMatch = candidate;
        }
      });
      return minDistance <= maxDistance ? closestMatch : null;
    };

    // 加载所有数据
    async function loadAllData() {
      try {
        const adminLevel = currentAdminLevel;
        let combinedData = [];

        if (adminLevel === 2) {
          // 使用新的admin2数据源
          const response = await fetch(
            'https://raw.githubusercontent.com/ZhangChuanxi1024/Sudan_displacement_data/main/sudan_admin2_displacement.json'
          );
          const data = await response.json();
          combinedData = data.result.map(item => ({
            NAME_1: item.admin1Name.trim(),
            NAME_2: (item.admin2Name || item.Admin2Name || '').trim(),
            numPresentIdpInd: Number(item.numPresentIdpInd) || 0,
            date: item.reportingDate.split('T')[0]
          }));
        } else {
          const response = await fetch(
            'https://raw.githubusercontent.com/ZhangChuanxi1024/Sudan_displacement_data/main/sudan_admin1_displacement.json'
          );
          const data = await response.json();
          combinedData = data.result.map(item => ({
            NAME_1: item.admin1Name.trim(),
            numPresentIdpInd: Number(item.numPresentIdpInd) || 0,
            date: item.reportingDate.split('T')[0]
          }));
        }

        dates = [...new Set(combinedData.map(d => d.date))]
          .sort((a, b) => new Date(a) - new Date(b));
        
        return combinedData;
      } catch (error) {
        console.error('数据加载失败:', error);
        return [];
      }
    }

    // 更新地图
    function updateMap(date) {
  const dailyData = allDisplacementData.filter(d => d.date === date);
  const displacementMap = new Map();
  const displacementNames = [];

  dailyData.forEach(item => {
    const key = currentAdminLevel === 2 ? 
      `${normalizeName(item.NAME_1)}|${normalizeName(item.NAME_2)}` : 
      normalizeName(item.NAME_1);

    displacementNames.push(key);
    displacementMap.set(key, item.numPresentIdpInd);
  });

  if (currentGeoLayer) currentGeoLayer.remove();

  currentGeoLayer = L.geoJSON(geoJsonData, {
    style: (feature) => {
      const rawState = feature.properties.NAME_1;
      const key = currentAdminLevel === 2 ? 
        `${normalizeName(rawState)}|${normalizeName(feature.properties.NAME_2)}` : 
        normalizeName(rawState);

      let value = displacementMap.get(key) || 0;

      if (value === 0) {
        const closest = findClosestMatch(key, displacementNames, 2);
        if (closest) {
          value = displacementMap.get(closest);
        }
      }

      return {
        fillColor: getColor(value),
        weight: currentAdminLevel === 1 ? 3 : 2,  // 一级边界加粗
        color: currentAdminLevel === 1 ? '#222' : '#2F4F4F', 
        fillOpacity: 0.8,
        dashArray: currentAdminLevel === 1 ? '0' : '3',
        className: `admin-boundary-${currentAdminLevel}`
      };
    },
    onEachFeature: (feature, layer) => {
      const key = currentAdminLevel === 2 ? 
        `${normalizeName(feature.properties.NAME_1)}|${normalizeName(feature.properties.NAME_2)}` : 
        normalizeName(feature.properties.NAME_1);

      let value = displacementMap.get(key) || 0;
      let matchedKey = key;

      if (value === 0) {
        const closest = findClosestMatch(key, displacementNames, 2);
        if (closest) {
          value = displacementMap.get(closest);
          matchedKey = closest;
        }
      }

      const popupContent = currentAdminLevel === 2 ? 
        `<b>${feature.properties.NAME_2}</b><br>
         State: ${feature.properties.NAME_1}<br>` :
        `<b>${feature.properties.NAME_1}</b><br>`;

      layer.bindPopup(`
        ${popupContent}
        Displaced: ${value.toLocaleString()}<br>
        Data Source: ${matchedKey.includes('|') ? 'Exact Match' : 'Fuzzy Match'}
      `);
    }
  }).addTo(map);
}


    // 添加行政区划切换监听
    document.getElementById('play-button').addEventListener('click', function () {
    if (isPlaying) {
        // 如果正在播放，则停止播放
        clearInterval(playInterval);
        isPlaying = false;
        this.textContent = '▶ Play';
    } else {
        // 开始播放
        isPlaying = true;
        this.textContent = '⏸ Pause';

        let timeline = document.getElementById('timeline');
        let currentIndex = parseInt(timeline.value);

        // **循环播放**：如果已经到最后一天，重置为第一天
        if (currentIndex >= dates.length - 1) {
            currentIndex = 0;
            timeline.value = currentIndex;
            document.getElementById('date-display').textContent = `Date: ${dates[currentIndex]}`;
            updateMap(dates[currentIndex]);
        }

        // **让时间轴不会卡住**：在 `setInterval` 里使用 `timeline.value`
        playInterval = setInterval(() => {
            if (!isPlaying) return; // **如果暂停，直接退出循环**

            currentIndex = parseInt(timeline.value); // **实时获取时间轴的值**
            if (currentIndex < dates.length - 1) {
                timeline.value = currentIndex + 1; // **增加时间**
                document.getElementById('date-display').textContent = `Date: ${dates[currentIndex + 1]}`;
                updateMap(dates[currentIndex + 1]);
            } else {
                // **播放到最后，自动回到起点**
                clearInterval(playInterval);
                isPlaying = false;
                this.textContent = '▶ Play';
            }
        }, 1000); // 每 1 秒播放下一帧
    }
});

    // 颜色梯度函数
    function getColor(d) {
      return d > 500000 ? '#08306b' :
             d > 200000 ? '#2171b5' :
             d > 100000 ? '#4292c6' :
             d > 50000  ? '#6baed6' :
             d > 10000  ? '#9ecae1' :
             d > 0      ? '#deebf7' :
                          '#ffffff';
    }

    // 加载地理数据
    async function loadGeoJSON(adminLevel) {
  try {
    const geoJsonUrl = adminLevel === 1 
      ? 'https://raw.githubusercontent.com/ZhangChuanxi1024/Sudan_displacement_data/main/gadm41_SDN_1.json'
      : 'https://raw.githubusercontent.com/ZhangChuanxi1024/Sudan_displacement_data/main/gadm41_SDN_2.json';

    const response = await fetch(geoJsonUrl);
    const data = await response.json();

    if (!data?.features?.length) throw new Error('地理数据格式无效');
    return data;

  } catch (error) {
    console.error('地理数据加载失败:', error);
    throw error;
  }
}


    // 初始化时间轴
    function initTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.max = dates.length - 1;
      
      timeline.addEventListener('input', function(e) {
        const index = parseInt(this.value);
        const date = dates[index];
        document.getElementById('date-display').textContent = `Date: ${date}`;
        updateMap(date);
      });
    }

    // 播放控制
    document.getElementById('admin-level').addEventListener('change', async function() {
  currentAdminLevel = parseInt(this.value);
  isPlaying = false;
  document.getElementById('play-button').textContent = '▶ Play';
  clearInterval(playInterval);

  try {
    allDisplacementData = await loadAllData();
    dates = [...new Set(allDisplacementData.map(d => d.date))].sort((a, b) => new Date(a) - new Date(b));

    // 重新加载边界数据
    geoJsonData = await loadGeoJSON(currentAdminLevel);

    // 重置时间轴
    document.getElementById('timeline').value = 0;
    document.getElementById('timeline').max = dates.length - 1;
    document.getElementById('date-display').textContent = `Date: ${dates[0]}`;
    
    updateMap(dates[0]); // 重新渲染地图

  } catch (error) {
    console.error('行政区划切换失败:', error);
  }
});


    // 添加图例
    function addLegend() {
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<h4 style="margin:5px 0 10px;font-weight:600">Displaced Population</h4>';
        
        const grades = [
          { min: 500000, color: '#08306b', label: '500,000+' },
          { min: 200000, max: 500000, color: '#2171b5', label: '200,000-500,000' },
          { min: 100000, max: 200000, color: '#4292c6', label: '100,000-200,000' },
          { min: 50000, max: 100000, color: '#6baed6', label: '50,000-100,000' },
          { min: 10000, max: 50000, color: '#9ecae1', label: '10,000-50,000' },
          { min: 0, max: 10000, color: '#deebf7', label: '0-10,000' },
          { min: -1, color: '#ffffff', label: 'No Data' }
        ];

        grades.forEach(grade => {
          const item = div.appendChild(document.createElement('div'));
          item.className = 'legend-item';
          item.innerHTML = `
            <div class="legend-color" 
                 style="background:${grade.color};
                        border:1px solid ${grade.min<0 ? '#ccc' : 'rgba(0,0,0,0.2)'}"></div>
            <span style="font-size:11px;color:#444">${grade.label}</span>
          `;
        });

        return div;
      };
      legend.addTo(map);
    }

    // 主初始化流程
    (async function main() {
      initMap();
      addLegend();

      try {
        geoJsonData = await loadGeoJSON();
        allDisplacementData = await loadAllData();
        
        if (dates.length > 0) {
          initTimeline();
          document.getElementById('date-display').textContent = `Date：${dates[0]}`;
          updateMap(dates[0]);
        } else {
          console.error('No valid date data');
        }
      } catch (error) {
        console.error('Initialization failed:', error);
        alert('Map initialization failed. Please check your connection and refresh.');
      }
    })();
  </script>
</body>
</html>